name: Build PHP and Publish Release

on:
  workflow_dispatch:
    inputs:
      php_version:
        description: "PHP version (ex: 7.4.33, 8.0.3, 8.1.27, 8.3.2)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    # usa ubuntu-20.04 para qualquer 7.x ou para 8.0.0/8.0.1/8.0.2; caso contrário ubuntu-latest
    runs-on: ${{ (startsWith(github.event.inputs.php_version, '7.') || contains('8.0.0 8.0.1 8.0.2', github.event.inputs.php_version)) && 'ubuntu-20.04' || 'ubuntu-latest' }}

    env:
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OpenSSL 1.1 manually
        run: |
          wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz
          tar -xzf openssl-1.1.1w.tar.gz
          cd openssl-1.1.1w
          ./config --prefix=/usr/local/openssl11 --openssldir=/usr/local/openssl11 shared
          make -j$(nproc)
          sudo make install
          echo "/usr/local/openssl11/lib" | sudo tee /etc/ld.so.conf.d/openssl11.conf
          sudo ldconfig

      - name: Install build deps
        run: |
          sudo apt update -y
          sudo apt install -y build-essential autoconf bison re2c pkg-config \
            libxml2-dev libsqlite3-dev libcurl4-openssl-dev libzip-dev \
            libonig-dev libreadline-dev libjpeg-dev libpng-dev \
            libwebp-dev libfreetype6-dev libxslt1-dev libicu-dev wget tar jq \
            libffi-dev libbz2-dev

      - name: Download PHP source
        run: |
          set -euo pipefail
          VERSION="${{ github.event.inputs.php_version }}"
          SRC="https://www.php.net/distributions/php-${VERSION}.tar.gz"
          wget -q "$SRC" -O "php-${VERSION}.tar.gz" || (echo "Falha ao baixar $SRC" && exit 1)
          tar -xzf "php-${VERSION}.tar.gz"
          mv "php-${VERSION}" php-src

      - name: Configure PHP
        working-directory: php-src
        run: |
          set -euo pipefail
          VERSION="${{ github.event.inputs.php_version }}"

          export OPENSSL_CFLAGS="-I/usr/local/openssl11/include"
          export OPENSSL_LIBS="-L/usr/local/openssl11/lib -lssl -lcrypto"

          ./buildconf --force || true

          # inicializa flag padrão
          INTL_FLAG="--enable-intl"

          # desabilita intl para 7.0.x (problemas com ICU muito novo)
          if [[ "$VERSION" =~ ^7\.0\..*$ ]]; then
            INTL_FLAG="--disable-intl"
          fi

          # Algumas versões antigas do 7.x podem exigir ajuste no zip/mcrypt,
          # mas vamos usar flags genéricas que funcionam na maioria dos casos.
          EXTRA_FLAGS=""

          # mcrypt era comum em 7.0/7.1 (se o configure falhar, verifica logs)
          if [[ "$VERSION" =~ ^7\.[01]\. ]]; then
            # só adiciona se a lib estiver presente; manter como tentativa
            EXTRA_FLAGS="$EXTRA_FLAGS --with-mcrypt"
          fi

          ./configure \
            --prefix=/opt/php/${VERSION} \
            --enable-cli \
            --enable-mbstring \
            --with-openssl=/usr/local/openssl11 \
            --with-curl \
            --with-zlib \
            --enable-pcntl \
            --enable-opcache \
            --with-readline \
            --with-zip \
            $INTL_FLAG \
            --with-xsl \
            --with-sqlite3 \
            --enable-fpm \
            --with-fpm-user=www-data \
            --with-fpm-group=www-data \
            --with-jpeg \
            --with-webp \
            --with-freetype \
            $EXTRA_FLAGS || (echo "configure falhou - ver config.log" && cat config.log && exit 1)

      - name: Build and install
        working-directory: php-src
        run: |
          set -euo pipefail
          make -j$(nproc)
          sudo make install

      - name: Package build
        run: |
          set -euo pipefail
          VERSION="${{ github.event.inputs.php_version }}"
          mkdir -p artifacts
          cd /opt/php
          tar -czf "${GITHUB_WORKSPACE}/artifacts/php-${VERSION}-linux-x64.tar.gz" "${VERSION}"

      - name: Compute checksum and size
        run: |
          set -euo pipefail
          ART="artifacts/php-${{ github.event.inputs.php_version }}-linux-x64.tar.gz"
          echo "sha256=$(sha256sum "$ART" | awk '{print $1}')" > artifact.meta
          echo "size=$(stat -c%s "$ART")" >> artifact.meta

      - name: Create GitHub Release and upload asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: php-${{ github.event.inputs.php_version }}
          name: "PHP ${{ github.event.inputs.php_version }}"
          files: |
            artifacts/php-${{ github.event.inputs.php_version }}-linux-x64.tar.gz
            artifact.meta
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update versions.json
        run: |
          set -euo pipefail
          VERSION="${{ github.event.inputs.php_version }}"
          TAG="php-${VERSION}"
          ASSET="php-${VERSION}-linux-x64.tar.gz"
          URL="https://github.com/${REPO}/releases/download/${TAG}/${ASSET}"

          SHA=$(grep sha256 artifact.meta | cut -d= -f2)
          SIZE=$(grep size artifact.meta | cut -d= -f2)

          if [ ! -f versions.json ]; then
            echo '{"versions":[]}' > versions.json
          fi

          jq \
            --arg v "$VERSION" \
            --arg u "$URL" \
            --arg s "$SHA" \
            --arg sz "$SIZE" \
            '.versions += [{
                version: $v,
                url: $u,
                arch: "x64",
                os: "linux",
                sha256: $s,
                size_bytes: ($sz|tonumber)
            }]' \
            versions.json > versions.tmp

          mv versions.tmp versions.json

      - name: Commit updated versions.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add versions.json || true
          git commit -m "Add PHP ${{ github.event.inputs.php_version }} to versions.json" || true
          git push || true
